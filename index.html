<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ex-Servicemen Security Guards Arrears Calculator - NIT Patna</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { text-align: center; }
        form { max-width: 600px; margin: 0 auto; }
        label { display: block; margin-top: 10px; }
        input { width: 100%; padding: 8px; margin-top: 5px; }
        button { display: block; width: 100%; padding: 10px; margin-top: 20px; background-color: #4CAF50; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #45a049; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .violation { color: red; }
        #total-arrears { font-weight: bold; margin-top: 20px; }
        .error { color: red; font-size: 0.9em; margin-top: 5px; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <h1>Ex-Servicemen Security Guards Arrears Calculator</h1>
    <p>This tool allows you to input your date of joining and consolidated pay received each month. It analyzes violations based on DGR/CLC minimum wages for NIT Patna, calculates underpayments, and generates a PDF for claiming arrears.</p>
    
    <form id="inputForm">
        <label for="name">Your Name:</label>
        <input type="text" id="name" name="name" required aria-required="true">
        <div id="name-error" class="error" aria-live="polite"></div>
        
        <label for="aadhaar">Aadhaar Number:</label>
        <input type="text" id="aadhaar" name="aadhaar" required pattern="\d{12}" placeholder="Enter 12-digit Aadhaar number" title="Aadhaar must be 12 digits" aria-required="true">
        <div id="aadhaar-error" class="error" aria-live="polite"></div>
        
        <label for="bankAccount">Indian Bank Salary Account No.:</label>
        <input type="text" id="bankAccount" name="bankAccount" required pattern="\d{9,18}" placeholder="Enter 9-18 digit account number" title="Account number must be 9-18 digits" aria-required="true">
        <div id="bankAccount-error" class="error" aria-live="polite"></div>
        
        <label for="dob">Date of Birth (YYYY-MM-DD):</label>
        <input type="date" id="dob" name="dob" required aria-required="true" min="1900-01-01" max="2005-10-04">
        <div id="dob-error" class="error" aria-live="polite"></div>
        
        <label for="mobile">Mobile Number:</label>
        <input type="tel" id="mobile" name="mobile" required pattern="\d{10}" placeholder="Enter 10-digit mobile number" title="Mobile must be 10 digits" aria-required="true">
        <div id="mobile-error" class="error" aria-live="polite"></div>
        
        <label for="email">Email Address:</label>
        <input type="email" id="email" name="email" required aria-required="true">
        <div id="email-error" class="error" aria-live="polite"></div>
        
        <label for="joiningDate">Date of Joining (YYYY-MM-DD):</label>
        <input type="date" id="joiningDate" name="joiningDate" required aria-required="true" min="2013-10-01" max="2025-10-04">
        <div id="joiningDate-error" class="error" aria-live="polite"></div>
        
        <button type="button" id="generateMonthsBtn">Generate Months & Input Pays</button>
    </form>
    
    <div id="tableContainer" style="display: none;">
        <table id="payTable">
            <thead>
                <tr>
                    <th>Month (YYYY-MM)</th>
                    <th>Required Total Wages (as per DGR/CLC)</th>
                    <th>Consolidated Pay Received</th>
                    <th>Difference (Underpayment)</th>
                    <th>Violation</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
        <div id="total-arrears"></div>
        <button type="button" id="generatePDFBtn">Generate Arrears Claim PDF</button>
    </div>

    <script>
    const wageData = [
        { month: 'Oct 2013', totalWages: 15661.71 },
        { month: 'Apr 2014', totalWages: 16630.48 },
        { month: 'Oct 2014', totalWages: 16791.94 },
        { month: 'Apr 2015', totalWages: 17653.06 },
        { month: 'Oct 2015', totalWages: 17892.22 },
        { month: 'Apr 2016', totalWages: 18645.65 },
        { month: 'Oct 2016', totalWages: 18998.57 },
        { month: 'Apr 2017', totalWages: 31821.12 },
        { month: 'Oct 2017', totalWages: 31915.45 },
        { month: 'Apr 2018', totalWages: 32938.03 },
        { month: 'Oct 2018', totalWages: 33622.50 },
        { month: 'Apr 2019', totalWages: 34920.71 },
        { month: 'Oct 2019', totalWages: 35477.10 },
        { month: 'Apr 2020', totalWages: 36878.46 },
        { month: 'Oct 2020', totalWages: 37428.61 },
        { month: 'Feb 2021', totalWages: 37428.61 },
        { month: 'Oct 2021', totalWages: 39007.25 },
        { month: 'Apr 2022', totalWages: 38594.64 },
        { month: 'Oct 2022', totalWages: 41070.33 },
        { month: 'Apr 2023', totalWages: 42354.02 },
        { month: 'Oct 2023', totalWages: 42896.90 },
        { month: 'Apr 2024', totalWages: 44462.95 },
        { month: 'Oct 2024', totalWages: 44738.03 },
        { month: 'Apr 2025', totalWages: 44426.48 },
        { month: 'Oct 2025', totalWages: 45884.18 }
    ];

    function getTotalWagesForMonth(yearMonth) {
        const [year, month] = yearMonth.split('-');
        const formattedMonth = `${month} ${year}`;
        const applicable = wageData.find(w => w.month === formattedMonth);
        if (!applicable) {
            const sorted = [...wageData].sort((a, b) => new Date(a.month) - new Date(b.month));
            const target = new Date(`${month} 1, ${year}`);
            for (let i = 0; i < sorted.length - 1; i++) {
                const curr = new Date(sorted[i].month);
                const next = new Date(sorted[i + 1].month);
                if (target >= curr && target < next) return sorted[i].totalWages;
            }
            return sorted[sorted.length - 1].totalWages;
        }
        return applicable.totalWages;
    }

    function validateForm() {
        const ids = ['name','aadhaar','bankAccount','dob','mobile','email','joiningDate'];
        let valid = true;
        ids.forEach(id => {
            const input = document.getElementById(id);
            const error = document.getElementById(`${id}-error`);
            if (!input.value) { error.textContent = 'Required field'; valid = false; }
            else if (!input.checkValidity()) { error.textContent = input.validationMessage; valid = false; }
            else { error.textContent = ''; }
        });
        return valid;
    }

    function formatDate(dateStr) {
        if (!dateStr) return '';
        const [y,m,d] = dateStr.split('-');
        return `${d}-${m}-${y}`;
    }

    function generateMonths() {
        if (!validateForm()) { alert('Please fill required fields.'); return; }

        const joiningDate = new Date(document.getElementById('joiningDate').value);
        const current = new Date();
        const tableBody = document.getElementById('tableBody');
        tableBody.innerHTML = '';
        let dt = new Date(joiningDate.getFullYear(), joiningDate.getMonth(), 1);
        const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        let rowCount = 0;

        while (dt <= current && rowCount < 180) {
            const yearMonth = `${dt.getFullYear()}-${monthNames[dt.getMonth()]}`;
            const required = getTotalWagesForMonth(yearMonth);
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${yearMonth}</td>
                <td>${required.toFixed(2)}</td>
                <td><input type="number" class="paid-input" value="0" min="0" step="0.01" onchange="calculateDifference(this)"></td>
                <td class="difference">0.00</td>
                <td class="violation"></td>`;
            tableBody.appendChild(tr);
            dt.setMonth(dt.getMonth() + 1);
            rowCount++;
        }

        document.getElementById('tableContainer').style.display = 'block';
        calculateAllDifferences();
    }

    function calculateDifference(input) {
        const row = input.closest('tr');
        const required = parseFloat(row.children[1].textContent);
        const paid = parseFloat(input.value) || 0;
        const diff = required - paid;
        row.children[3].textContent = diff.toFixed(2);
        row.children[4].textContent = diff > 0 ? 'Underpaid' : 'No Violation';
        row.children[4].classList.toggle('violation', diff > 0);
        calculateTotalArrears();
    }

    function calculateAllDifferences() {
        document.querySelectorAll('.paid-input').forEach(i => calculateDifference(i));
    }

    function calculateTotalArrears() {
        let total = 0;
        document.querySelectorAll('.difference').forEach(d => total += parseFloat(d.textContent) || 0);
        document.getElementById('total-arrears').textContent = `Total Arrears: ₹${total.toFixed(2)}`;
        return total;
    }

    // 🔹 PREVIEW FUNCTION
    function previewClaim() {
        if (!validateForm()) { alert('Please fill out all required fields correctly.'); return; }
        if (document.querySelectorAll('#payTable tbody tr').length === 0) {
            alert('Please generate months first.'); return;
        }

        const name = document.getElementById('name').value;
        const aadhaar = document.getElementById('aadhaar').value;
        const bank = document.getElementById('bankAccount').value;
        const dob = formatDate(document.getElementById('dob').value);
        const mobile = document.getElementById('mobile').value;
        const email = document.getElementById('email').value;
        const join = formatDate(document.getElementById('joiningDate').value);
        const total = calculateTotalArrears();

        let html = `
        <div id="previewArea" style="margin-top:40px;border:1px solid #ccc;padding:20px;font-family:Arial;line-height:1.5">
        <h2 style="text-align:center;">NIT Patna Ex-Servicemen Security Guards Arrears Claim Letter</h2>
        <p><b>Name:</b> ${name}<br>
        <b>Aadhaar:</b> ${aadhaar}<br>
        <b>Date of Joining:</b> ${join}<br>
        <b>Bank Account:</b> ${bank}<br>
        <b>Date of Birth:</b> ${dob}<br>
        <b>Mobile:</b> ${mobile}<br>
        <b>Email:</b> ${email}</p>
        <p><b>To,</b><br>The Director, NIT Patna</p>
        <p><b>Subject:</b> Claim for Arrears Due to Violations of DGR Minimum Wages, Non-Provision of EPF, and Other Allowances</p>
        <p>Dear Sir/Madam,<br>
        I am an ex-serviceman security guard employed directly by NIT Patna through the Sainik Kalyan Board, AWPO Danapur. I hereby claim the following arrears based on underpayments and violations:</p>
        <table border="1" cellspacing="0" cellpadding="4" style="width:100%;border-collapse:collapse;font-size:14px">
        <tr style="background:#f2f2f2"><th>Month</th><th>Required Wages</th><th>Paid</th><th>Difference</th><th>Status</th></tr>`;

        document.querySelectorAll('#payTable tbody tr').forEach(row => {
            const cells = row.children;
            html += `<tr>
                <td>${cells[0].textContent}</td>
                <td>${cells[1].textContent}</td>
                <td>${cells[2].querySelector('input').value}</td>
                <td>${cells[3].textContent}</td>
                <td>${cells[4].textContent}</td>
            </tr>`;
        });

        html += `</table>
        <p><b>Total Arrears: ₹${total.toFixed(2)}</b></p>
        <p>I kindly request the immediate release of the above arrears along with applicable interest. Please address this matter at the earliest convenience.</p>
        <p>Yours sincerely,<br><b>${name}</b></p>
        <button onclick="window.print()" style="margin-top:20px;padding:10px 20px;">🖨️ Print This Preview</button>
        </div>`;

        const previewDiv = document.getElementById('previewDiv') || document.createElement('div');
        previewDiv.id = 'previewDiv';
        previewDiv.innerHTML = html;
        document.body.appendChild(previewDiv);
        window.scrollTo({ top: previewDiv.offsetTop, behavior: 'smooth' });
    }

    // 🔹 FIXED PDF GENERATION (with no overlap)
    function generatePDF() {
    if (!validateForm()) {
        alert('Please fill out all required fields.');
        return;
    }
    if (document.querySelectorAll('#payTable tbody tr').length === 0) {
        alert('Please generate months first.');
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

    const name = document.getElementById('name').value;
    const aadhaar = document.getElementById('aadhaar').value;
    const bank = document.getElementById('bankAccount').value;
    const dob = formatDate(document.getElementById('dob').value);
    const mobile = document.getElementById('mobile').value;
    const email = document.getElementById('email').value;
    const join = formatDate(document.getElementById('joiningDate').value);
    const total = calculateTotalArrears();

    let y = 10, margin = 10, lh = 7, pageH = 297, maxY = pageH - margin;
    const contentW = 190;
    const addText = (t, b = false) => {
        doc.setFont('times', b ? 'bold' : 'normal');
        const lines = doc.splitTextToSize(t, contentW);
        lines.forEach(line => {
            if (y + lh > maxY) { doc.addPage(); y = margin; }
            doc.text(line, margin, y); y += lh;
        });
    };

    doc.setFont('times', 'bold');
    doc.setFontSize(16);
    addText('NIT Patna Ex-Servicemen Security Guards Arrears Claim Letter', true);
    y += 5;
    doc.setFontSize(12);
    doc.setFont('times', 'normal');

    // Personal details
    addText(`Name: ${name}`);
    addText(`Aadhaar: ${aadhaar}`);
    addText(`Date of Joining: ${join}`);
    addText(`Bank Account: ${bank}`);
    addText(`Date of Birth: ${dob}`);
    addText(`Mobile: ${mobile}`);
    addText(`Email: ${email}`);
    y += 5;

    // Subject and letter
    addText("To,");
    addText("The Director, NIT Patna");
    addText("Subject: Claim for Arrears Due to Violations of DGR Minimum Wages, Non-Provision of EPF, and Other Allowances");
    addText("Dear Sir/Madam,");
    addText("I am an ex-serviceman security guard employed directly by NIT Patna through the Sainik Kalyan Board, AWPO Danapur. I hereby claim the following arrears based on underpayments and violations:");

    // Table Header
    y += 3;
    const headers = ["Month", "Required Wages", "Paid", "Difference", "Violation"];
    const colWidths = [35, 35, 30, 30, 40];
    const colStart = margin;
    const colSpacing = colWidths.reduce((a, b) => a + b, 0);

    const drawRow = (rowData) => {
        if (y + lh > maxY) { doc.addPage(); y = margin; }
        let x = margin;
        rowData.forEach((text, i) => {
            doc.rect(x, y - 5, colWidths[i], lh + 2); // draw cell
            doc.text(`${text}`, x + 1, y); // add text
            x += colWidths[i];
        });
        y += lh + 2;
    };

    // Draw table header
    doc.setFont('times', 'bold');
    drawRow(headers);
    doc.setFont('times', 'normal');

    // Draw table rows
    document.querySelectorAll('#payTable tbody tr').forEach(row => {
        const month = row.children[0].textContent;
        const required = row.children[1].textContent;
        const paid = row.children[2].querySelector('input').value;
        const diff = row.children[3].textContent;
        const status = row.children[4].textContent;
        drawRow([month, required, paid, diff, status]);
    });

    // Total arrears
    y += 5;
    addText(`Total Arrears: ₹${total.

    // event listeners
    document.getElementById('generateMonthsBtn').addEventListener('click', generateMonths);

    // dynamically insert preview and pdf buttons after table
    const container = document.getElementById('tableContainer');
    const previewBtn = document.createElement('button');
    previewBtn.textContent = 'Preview Arrears Claim Letter';
    previewBtn.style.marginTop = '10px';
    previewBtn.onclick = previewClaim;
    container.appendChild(previewBtn);

    document.getElementById('generatePDFBtn').addEventListener('click', generatePDF);
</script>

